#!/usr/bin/env bash

wallpaper_folder="$HOME/Pictures/wallpapers"
index_tracker="$HOME/.local/state/wallpaper_index"
active_wallpaper="$HOME/.local/state/current_wallpaper"

mapfile -t wallpaper_list < <(find "$wallpaper_folder" -type f \( -iname '*.png' -o -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.gif' \) | sort)

selected_index=$(
  for path in "${wallpaper_list[@]}"; do
    printf '%s\x00icon\x1fthumbnail://%s\n' "$(basename "$path")" "$path"
  done | rofi -dmenu -p "Select Wallpaper" -format i -theme "$HOME/.config/rofi/wallpaper-selector.rasi"
)

[[ -z "$selected_index" ]] && exit 0

selected_path="${wallpaper_list[$selected_index]}"

if [ -f "$selected_path" ]; then
    ln -sf "$selected_path" "$active_wallpaper"
    matugen image "$active_wallpaper"
    echo "$selected_index" > "$index_tracker"

    styles=("grow" "outer" "wipe" "wave")
    positions=("center" "top" "bottom" "left" "right" "top-left" "top-right" "bottom-left" "bottom-right")
    waves=("20,20" "30,15" "25,25" "40,10")

    awww img "$active_wallpaper" \
        --transition-type "${styles[$RANDOM % ${#styles[@]}]}" \
        --transition-pos "${positions[$RANDOM % ${#positions[@]}]}" \
        --transition-wave "${waves[$RANDOM % ${#waves[@]}]}" \
        --transition-duration "1.5" \
        --transition-fps "60" \
        --transition-angle "$(( RANDOM % 360 ))"
fi
